#
# Copyright (c) 2019-2020 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#
# https://github.com/P3TERX/Actions-OpenWrt
# Description: Build OpenWrt using GitHub Actions
#

name: Build OpenWrt Single

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'
      target:
        description: 'build/${target} to build'
        required: false
        default: 'x86_64'
      n1_kernal:
        description: 'N1 kernal'
        required: false
        default: ''
      config:
        description: 'config file to build'
        required: false
        default: 'config.buildinfo'
      os:
        description: 'os to use'
        required: false
        default: 'ubuntu-20.04'
      repo:
        description: 'json raw string about repo to use'
        required: false
        default: '[{"name":"lede","url":"https://github.com/coolsnowwolf/lede"},{"name":"immortalwrt","url":"https://github.com/immortalwrt/immortalwrt"}]'

env:
  #REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  #CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  DIY_AFTER: diy-after.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: false
  TZ: Asia/Shanghai
  DOCKER_PASS: ${{ secrets.DOCKER_PASS }}
  NOT_PUSH: ${{ secrets.NOT_PUSH }}

jobs:
  set_matrix:
    runs-on: ${{ github.event.inputs.os }}
    outputs:
      build_repo: ${{ steps.set-matrix.outputs.matrix }}
    name: "set matrix: ${{matrix.repo}}"
    strategy:
      fail-fast: false
      matrix:
        repo: # ÂçïË°åÂ∞±ÊòØÊï∞ÁªÑÔºåÂä®ÊÄÅ matrix ËøôÊ†∑Âéª hack
          #- '[{"name":"lede","url":"https://github.com/coolsnowwolf/lede"},{"name":"immortalwrt","url":"https://github.com/immortalwrt/immortalwrt"}]'
          - '${{ github.event.inputs.repo }}'
    steps:
    - name: prinf info
      id: set-matrix
      run: |
        #echo '::set-output name=matrix::${{ toJson(matrix.repo) }}' # '["1","2","3"]'
        echo '${{ toJson(github) }}'
        echo '::set-output name=matrix::${{ matrix.repo }}'

  build:
    needs: set_matrix
    runs-on: ${{ github.event.inputs.os }}
    outputs:
      imageBuilder: ${{ steps.organize.outputs.imageBuilder }}
      build_target: ${{ steps.organize.outputs.build_target }}
    name: "ÁºñËØë ${{matrix.repo.name}} for ${{matrix.target}} - config: ${{ github.event.inputs.config }}"
    strategy:
      fail-fast: false
      matrix:
        target: 
          - "${{ github.event.inputs.target }}"
        repo: ${{ fromJson(needs.set_matrix.outputs.build_repo) }}
    steps:
    - name: Checkout
      uses: actions/checkout@main

    # - name: install docker
    #   uses: docker-practice/actions-setup-docker@master
      
    - name: prinf info
      run: |
        df -h
        lscpu
        free -h
        echo 'target: ${{matrix.target}}'

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install python3-markdown $(curl -fsSL git.io/depends-ubuntu-2004) zstd upx
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir 
        sudo chown $USER:$GROUPS /workdir 
        # install github cli tool
        wget -q https://github.com/cli/cli/releases/download/v2.10.1/gh_2.10.1_linux_amd64.tar.gz
        tar zxf gh_*_linux_amd64.tar.gz
        find gh_* -type f -name gh -exec mv {} /usr/local/bin/ \;
        sudo chmod a+x /usr/local/bin/gh
        gh auth login --with-token <<< ${{ secrets.gh_token }}
        if command -v docker &>/dev/null && [ -n "${DOCKER_PASS}" ];then
          docker login -u zhangguanzhang -p ${DOCKER_PASS}
        fi

    - name: Clone source code
      working-directory: /workdir
      run: |
        df -hT $PWD
        #git clone $REPO_URL -b $REPO_BRANCH openwrt
        git clone ${{matrix.repo.url}} -b $REPO_BRANCH openwrt
        \cp -a ${GITHUB_WORKSPACE}/build/${{matrix.target}}/* ${GITHUB_WORKSPACE}/build/common.buildinfo ${GITHUB_WORKSPACE}/
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        readlink -f $GITHUB_WORKSPACE/openwrt
        ls -l . openwrt
        # lede Âíå Â§©ÁÅµ Ê∫êÁ†Å‰ªìÂ∫ìÂêçÂ≠ó‰Ωú‰∏∫ÁºìÂ≠òÁöÑÂâçÁºÄ
        echo "repo_use=$( echo ${{matrix.repo.name}} | awk -F/ '{print $NF}' )" >> $GITHUB_ENV

    - name: Load custom feeds
      run: |
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
        chmod +x $DIY_P1_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: Update feeds
      run: cd openwrt && ./scripts/feeds update -a

    - name: Install feeds
      run: cd openwrt && ./scripts/feeds install -a

    - name: Load custom configuration
      run: |
        # set -x
        [ -e files ] && mv files openwrt/files
        export CONFIG=${{ github.event.inputs.config }}
        echo "use the .config file:" "${CONFIG}"
        cp config/${CONFIG} openwrt/.config
        cp common.buildinfo openwrt/
        # ---- ÂâçÁöÑË°åÂÜôÂÖ•
        sed -n '/---/{q};p' openwrt/common.buildinfo >> openwrt/.config
        chmod +x $DIY_P2_SH
        
        pushd openwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH
        popd

        if [ "${{matrix.target}}" != N1 ];then
          # ÂºÄÂêØ imagebuilder ÁöÑËØùÊ≠§ÂàªÊääÂéüÊúâÁöÑ .config Êã∑Ë¥ùËøõÂéªÔºåimagebuilderÁöÑxzÊòØË∞ÉÁî®ÁöÑ‰∏ìÈó®ÂéãÁº©ÔºåÊó†Ê≥ïÁîüÊàêÂêéÊèíÂÖ•Êñá‰ª∂ÔºåÊ≠§Â§ÑÊèêÂâçhack‰∏ãÊèíÂÖ•Êñá‰ª∂ÂêéÈù¢Áî®Âà∞
          if grep -Eq '^CONFIG_IB=y'  openwrt/.config;then
            gh release -R ${GITHUB_REPOSITORY} list | grep -Ew cache || gh release -R ${GITHUB_REPOSITORY} create cache -t '' -n ''
            gh release -R ${GITHUB_REPOSITORY} view cache 2>/dev/null | grep -Po 'asset:\s+\K\S+' > /tmp/log || true
            
            if grep -E "${repo_use}.${{matrix.target}}.img.zst" /tmp/log;then
              gh release -R ${GITHUB_REPOSITORY} download cache -p "${repo_use}.${{matrix.target}}.img.zst.*"
              cat ${repo_use}.*.img.zst.* | zstdmt -d -o ${repo_use}.img
              rm -f ${repo_use}.*.img.zst.*
            else
              truncate -s 30g ${repo_use}.img && mkfs.btrfs -M ${repo_use}.img
              NO_CACHE=1
              echo "NO_CACHE=1" >> $GITHUB_ENV
            fi

            LOOP_DEVICE=$(losetup -f) && echo "LOOP_DEVICE=$LOOP_DEVICE" >> $GITHUB_ENV
            sudo losetup -P --direct-io $LOOP_DEVICE ${repo_use}.img
            mkdir cache && sudo mount -o nossd,compress=zstd $LOOP_DEVICE cache
            sudo chown -R $USER:$GROUPS cache
            # https://forum.openwrt.org/t/using-precompiled-toolchain/87446/6
            mkdir -p cache/{build_dir,staging_dir} openwrt/{build_dir,staging_dir}
            (
              if [ "$NO_CACHE" != 1 ];then
                cd cache
                find build_dir/{host*,toolchain-*} -name .built\* -exec touch {} \;
                touch staging_dir/{host*,toolchain-*}/stamp/.*
              fi
            )
            sudo mount --bind cache/build_dir    openwrt/build_dir
            sudo mount --bind cache/staging_dir  openwrt/staging_dir
            pushd openwrt
            if [ "$NO_CACHE" != 1 ];then
              cp .config config.buildinfo
              sed_num=$( grep -n '$(TOPDIR)/.config' target/imagebuilder/Makefile | cut -d: -f1 )
              sed -ri ${sed_num}'{s#cp#& -a $(TOPDIR)/files $(TOPDIR)/*.buildinfo#;s#.config$##;}' target/imagebuilder/Makefile
              if [ "${repo_use}" == lede ];then
                find package/ -type d -name luci-app-* | awk -F/ '{printf "CONFIG_PACKAGE_%s=m\n",$NF}' >> .config
              fi
              #sed -ri 's#(^CONFIG_PACKAGE_luci-app-[^A-Z]*=)y#\1m#' .config
              sed -ri '/CONFIG_PACKAGE_[0-9a-z-]+(=| )/{s@^#\s+@@;s@(=y|\s+is not set)@=m@}' .config
            fi
            popd
          fi
        fi
        if [ ! -f 'openwrt/config.buildinfo' ];then
          cp openwrt/.config openwrt/config.buildinfo
        fi
        sed -n '/---/,$p' openwrt/common.buildinfo >> openwrt/.config
        sed -n '/---/,$p' openwrt/common.buildinfo >> openwrt/config.buildinfo
        #cat openwrt/.config

    - name: SSH connection to Actions
      uses: P3TERX/ssh2actions@v1.0.0
      if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')
      env:
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

    - name: Download package
      id: package
      run: |
        cd openwrt
        make defconfig
        sed -ri 's@^#\s(CONFIG_.+?_UPX) is not set@\1=y@' .config
        make defconfig
        # ÂºÄÂêØ imagebuilder ÁöÑËØù ‰øùÁïô‰∏Ä‰∏™.config.bak ÁªôÈùû slim ‰ΩøÁî®
        if [ "${{matrix.target}}" != N1 ] && [ "$NO_CACHE" != 1 ];then
          if grep -Eq '^CONFIG_IB=y' .config;then
            if [ "$NO_CACHE" != 1 ];then
              mv .config config.slim
              cat config.buildinfo > .config
              make defconfig
              cp .config full.buildinfo # ÈùûslimÁöÑÊñá‰ª∂
              cat config.slim > .config
              # sed -ri '/option check_signature/s@option@#&@' ./package/system/opkg/Makefile
            else
              # Â¶ÇÊûúÂàùÊ¨°Ê≤°ÁºìÂ≠òÔºåÂè™ÁºñËØëÂü∫Á°ÄÁöÑ
              cat common.buildinfo > .config
              make defconfig
              sed -ri '/^CONFIG_PACKAGE_luci-app-[0-9a-z-]+=y/{s@^@# @;s@=y@ is not set@}' .config
              make defconfig
            fi
          fi

        fi
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
        cat .config
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV

    - name: Upload buildInfo
      uses: actions/upload-artifact@main
      if: '!cancelled()'
      with:
        name: openwrt-buildInfo-${{ env.DEVICE_NAME }}-${{ env.repo_use }}
        # https://github.com/actions/upload-artifact/issues/92
        path: |
          /workdir/openwrt/.config
          /workdir/openwrt/*.buildinfo

    - name: Compile the firmware
      id: compile
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        if [ "${{matrix.target}}" != N1 ] ;then

          createdAt=$(gh -R ${GITHUB_REPOSITORY}  run list --json databaseId,createdAt --jq ".[]|select(.databaseId==${{ github.run_id }})|.createdAt")
          usedSec=$(( `date +%s` - `date -d "$createdAt" +%s`  ))
          # 6Â∞èÊó∂Ë∂ÖÊó∂ÔºåÂáèÂéª‰∏ä‰º† cache È¢ÑÁïôÁöÑ 10 ÂàÜÈíüÂêéÁöÑÊó∂Èó¥‰Ωú‰∏∫ timeout Êó∂Èó¥
          timeoutSec=$(( 6*60*60 - 10*60 - $usedSec  ))
          # ÂàùÊ¨°Ê≤°ÁºìÂ≠òÁî® timeout ÂêéÈò≤Ê≠¢Ë∂ÖÊó∂ action ÔºåÂêéÈù¢‰ºö‰∏ä‰º†ÁºìÂ≠òÁõÆÂΩï
                # time make -j$(nproc) IGNORE_ERRORS=1 || make -j1 IGNORE_ERRORS=1 || make -j1 V=s IGNORE_ERRORS=1
          echo timeout $timeoutSec make -j$(nproc) IGNORE_ERRORS=1
          timeout $timeoutSec make -j$(nproc) IGNORE_ERRORS=1
        else
          make -j$(nproc) || make -j1 || make -j1 V=s
        fi
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: Check space usage
      if: (!cancelled())
      run: |
        df -hT
        df -i
        ls -al openwrt/
        ls -lh openwrt/bin/targets/*/*

    - name: Upload bin directory
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: openwrt/bin

    - name: Organize files
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        pwd
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        if grep -Eq '^CONFIG_IB=y' $GITHUB_WORKSPACE/openwrt/.config;then
          echo "::set-output name=status::not_upload_compile"
        else
          echo "::set-output name=status::success"
        fi

        if ls *-imagebuilder-* &>/dev/null;then
          echo "::set-output name=imageBuilder::openwrt-imagebuilder-${{ env.DEVICE_NAME }}"
        fi
        echo "::set-output name=build_target::${{matrix.target}}"

    # - name: Do something after Compile
    #   if: steps.organize.outputs.status == 'success' && !cancelled()
    #   run: |
    #     cd openwrt
    #     if [ -f "$GITHUB_WORKSPACE/$DIY_AFTER" ];then
    #       bash $GITHUB_WORKSPACE/$DIY_AFTER
    #     fi

    - name: Upload firmware directory
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}-${{ env.repo_use }}
        path: |
          ${{ env.FIRMWARE }}
          !${{ env.FIRMWARE }}/openwrt-imagebuilder*

    - name: Upload imagebuilder tar.xz
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.imageBuilder && !cancelled()
      with:
        name: openwrt-imagebuilder-${{ env.DEVICE_NAME }}-${{ env.repo_use }}
        path: ${{ env.FIRMWARE }}/*-imagebuilder*

    - name: Upload firmware to cowtransfer
      id: cowtransfer
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_COWTRANSFER == 'true' && !cancelled()
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer cow --block 2621440 -s -p 64 --no-progress ${FIRMWARE} 2>&1 | tee cowtransfer.log
        echo "::warning file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
        echo "::set-output name=url::$(cat cowtransfer.log | grep https | cut -f3 -d" ")"

    - name: Upload firmware to WeTransfer
      id: wetransfer
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_WETRANSFER == 'true' && !cancelled()
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer wet -s -p 16 --no-progress ${FIRMWARE} 2>&1 | tee wetransfer.log
        echo "::warning file=wetransfer.com::$(cat wetransfer.log | grep https)"
        echo "::set-output name=url::$(cat wetransfer.log | grep https | cut -f3 -d" ")"

    - name: Generate release tag
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "::set-output name=release_tag::$(date +"%Y.%m.%d-%H%M")"
        touch release.txt
        [ $UPLOAD_COWTRANSFER = true ] && echo "üîó [Cowtransfer](${{ steps.cowtransfer.outputs.url }})" >> release.txt
        [ $UPLOAD_WETRANSFER = true ] && echo "üîó [WeTransfer](${{ steps.wetransfer.outputs.url }})" >> release.txt
        echo "::set-output name=status::success"

    - name: Upload firmware to release
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: Clean space for upload cache
      id: up_cache_before
      if: '!cancelled()'
      continue-on-error: true
      run: |
        if [ "${{matrix.target}}" != N1 ];then
          sync
          (
            cd openwrt/bin/targets/*/*
            if ls *-imagebuilder-* &>/dev/null;then
              # Ê∏ÖÁêÜ‰∏ãÔºåÈò≤Ê≠¢Ê≠§Ê≠•‰∏ä‰º†Ë∂ÖÊó∂
              rm -rf openwrt-*
            fi
          )
          rm -rf openwrt/dl/ # Èò≤Ê≠¢ action Èáå inode Â§™Â§öÊä•ÈîôÂÆπÈáè‰∏çÂ§ü
        fi
        echo "Listing 100 largest packages"
        dpkg-query -Wf '${Installed-Size}\t${Package}\n' | sort -n | tail -n 100
        df -h
        echo "Removing large packages"
        sudo apt-get remove -y '^ghc-8.*' || true
        sudo apt-get remove -y '^dotnet-.*' || true
        sudo apt-get remove -y '^llvm-.*' || true
        sudo apt-get remove -y 'php.*' || true
        sudo apt-get remove -y azure-cli google-cloud-sdk hhvm google-chrome-stable firefox powershell mono-devel || true
        sudo apt-get autoremove -y || true
        sudo apt-get clean || true
        df -h
        df -i
    - name: Upload cache to release
      id: up_cache
      if: '!cancelled()'
      continue-on-error: true
      run: |
        if [ "${{matrix.target}}" != N1 ];then
          sudo umount openwrt/{build_dir,staging_dir} cache
          #sudo losetup -l -O NAME -n | awk '$0~"/${repo_use}.img"{print $1}' | xargs -r sudo losetup -d
          sudo losetup -l -O NAME -n | awk '$0~"/'${repo_use}'.img"{print $1}' | xargs -r sudo losetup -d
          sleep 2
          sync
          zstdmt -c --long ${repo_use}.img | split --numeric=1 -b 2000m - ${repo_use}.${{matrix.target}}.img.zst.
          ls -l
          rm -f ${repo_use}.img # ÂáèÂ∞ëÂÆπÈáè
          gh release -R ${GITHUB_REPOSITORY} upload cache ${repo_use}.*.img.zst.* --clobber
        fi

    - name: Delete workflow runs
      uses: GitRML/delete-workflow-runs@main
      with:
        retain_days: 1
        keep_minimum_runs: 3

    - name: Remove old Releases
      uses: dev-drprasad/delete-older-releases@v0.1.0
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build_slim:
    needs: [set_matrix, build]
    if: needs.build.outputs.imageBuilder
    runs-on: ${{ github.event.inputs.os }}
    name: "ÁºñËØë repo: ${{matrix.repo.name}} - ${{matrix.target}}"
    strategy:
      fail-fast: false
      matrix:
        target: 
          - "slim"
          - "full"
        repo: ${{ fromJson(needs.set_matrix.outputs.build_repo) }}
    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: install docker
      uses: docker-practice/actions-setup-docker@master
      
    - name: prinf info
      run: |
        df -h
        lscpu
        free -h
        echo 'target: ${{matrix.target}}'
        # lede Âíå Â§©ÁÅµ Ê∫êÁ†Å‰ªìÂ∫ìÂêçÂ≠ó‰Ωú‰∏∫ÁºìÂ≠òÁöÑÂâçÁºÄ
        echo "repo_use=${{matrix.repo.name}}" >> $GITHUB_ENV

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install python3-markdown $(curl -fsSL git.io/depends-ubuntu-2004)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
        i=0
        while [ "$i" -le 100 ];do
          if command -v docker &>/dev/null && [ -n "${DOCKER_PASS}" ];then
            docker info | grep -wq 'zhangguanzhang'  || docker login -u zhangguanzhang -p ${DOCKER_PASS}
            docker login -u zhangguanzhang@qq.com -p ${DOCKER_PASS} registry.aliyuncs.com
            [ "$?" -eq 0 ] && break || lei i++
          fi
        done
        docker info

    - name: Download imagebuilder (Artifact)
      uses: actions/download-artifact@v2
      with:
        name: ${{ needs.build.outputs.imageBuilder }}-${{ env.repo_use }}
        path: .

    - name: Compile the firmware
      id: compile
      run: |
        ls -l
        \cp -a ${GITHUB_WORKSPACE}/build/${{ needs.build.outputs.build_target }}/* ${GITHUB_WORKSPACE}/build/common.buildinfo ${GITHUB_WORKSPACE}/
        tar xf openwrt-imagebuilder-*.tar.xz
        rm -f openwrt-imagebuilder-*.tar.xz
        ln -sf openwrt-imagebuilder-* openwrt
        cd openwrt-imagebuilder-*
        ls -l

        echo -e "$(nproc) thread compile"
        ls -1 packages/*.ipk | wc -l
        ls packages/

        > /tmp/log
        if [ "${{matrix.target}}" == 'slim' ];then
          mkdir -p files/local_feed && sudo mount --bind packages files/local_feed
          echo "suffix=-slim" >> $GITHUB_ENV
        else
          echo "suffix=" >> $GITHUB_ENV
        fi

        sed -i 's/luci-app-[^ ]*//g' include/target.mk $(find target/ -name Makefile)
        ls packages/*.ipk | xargs -n1 basename > package.list
        #PACKAGES=$(grep -v CONFIG_PACKAGE_luci-app common.buildinfo | grep -Po '^CONFIG_PACKAGE_\K[^A-Z=]+(?==y)' | xargs -n1 -i grep -o {} package.list | sort -u | xargs echo )
        #extra_pkgs="luci-i18n-base-zh-cn luci-i18n-firewall-zh-cn luci-app-ttyd bash default-settings luci-app-docker -luci-app-ssr-plus -luci-app-samba"

        extra_pkgs=" -luci-app-ssr-plus -luci-app-samba"
        if [ "${{matrix.target}}" == 'slim' ];then
          PACKAGES=$( grep -Po '^CONFIG_PACKAGE_\K[^A-Z=]+' common.buildinfo | tr '\n' ' ' )
        else
          PACKAGES=$( grep -Po '^CONFIG_PACKAGE_\K[^A-Z=]+(?==y)' full.buildinfo | xargs -n1 -i grep -o {} package.list | awk '!a[$0]++' | xargs echo )
        fi
        make image PACKAGES="$PACKAGES ${extra_pkgs}" FILES="files" |& tee -a /tmp/log
        REMOVE_PKGS=$( grep -Po 'Cannot install package \K[^.]+' /tmp/log | awk '{printf "-%s ",$0}' )
        if [ -n "$REMOVE_PKGS" ];then
          echo "ÊâìÂåÖÊä•ÈîôÔºåÂ∑≤‰∏ãÂåÖÂ≠òÂú®‰æùËµñÈóÆÈ¢ò: ${REMOVE_PKGS}"
          echo "Â∞ùËØïÁßªÈô§‰∏äÈù¢ÁöÑÂåÖÊâìÂåÖ"
          # ‰∏çÂà†Èô§Âàô‰ºöÊñá‰ª∂Â∑≤Â≠òÂú®ËÄå‰∏çÊõ¥Êñ∞Á≠æÂêçÔºåË≤å‰ººËøôÊ†∑‰πüËß£ÂÜ≥‰∏ç‰∫Ü„ÄÇ„ÄÇ,ÂêéÈù¢Êîπ sed -ri '/check_signature/s@^[^#]@#&@' /etc/opkg.conf ÊöÇÊó∂Â±èËîΩÂâçÈù¢ÈîôËØØ
          rm -f files/local_feed/Packages*
          make image PACKAGES="$PACKAGES ${extra_pkgs} ${REMOVE_PKGS}" FILES="files"
        fi

        #make image -j$(nproc) PACKAGES='-luci-app-ipsec-vpnd' || make image -j1 V=s PACKAGES='-luci-app-ipsec-vpnd' 

        echo "::set-output name=status::success"
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: Organize files
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd openwrt-imagebuilder-*/bin/targets/*/*
        pwd
        ls -lh
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "::set-output name=status::success"

    - name: Do something after Compile
      if: steps.organize.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt-imagebuilder-*/
        if [ -f "$GITHUB_WORKSPACE/$DIY_AFTER" ];then
          bash $GITHUB_WORKSPACE/$DIY_AFTER ${{ env.repo_use }} ${{ env.suffix }} 
        fi

    - name: Upload firmware directory
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}${{ env.suffix }}-${{ env.repo_use }}
        path: |
          ${{ env.FIRMWARE }}
