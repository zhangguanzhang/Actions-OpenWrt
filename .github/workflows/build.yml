#
# Copyright (c) 2019-2020 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#
# https://github.com/P3TERX/Actions-OpenWrt
# Description: Build OpenWrt using GitHub Actions
#

name: Build OpenWrt

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'
      target:
        description: 'build/${target} to build'
        required: false
        default: 'r2s' #'x86_64'
      envOverride:
        description: 'key=value,key2=value2'
        required: false
        default: ''
      config:
        description: 'config file to build'
        required: false
        default: 'config.buildinfo'
      os:
        description: 'os to use'
        required: false
        default: 'ubuntu-20.04'

env:
  FEEDS_CONF: feeds.conf.default
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  DIY_AFTER: diy-after.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: false
  TZ: Asia/Shanghai
  DOCKER_PASS: ${{ secrets.DOCKER_PASS }}
  NOT_PUSH: ${{ secrets.NOT_PUSH }}
  envOverride: ${{ github.event.inputs.envOverride }}

jobs:
  set_matrix:
    runs-on: ${{ github.event.inputs.os }}
    outputs:
      build_repo: ${{ steps.set_matrix.outputs.matrix }}
    name: "set matrix for: ${{ github.event.inputs.target }}"

    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: prinf info
      id: set_matrix
      run: |
        echo '${{ toJson(github) }}'
        pwd # /home/runner/work/Actions-OpenWrt/Actions-OpenWrt
        ls -l
        bash build/${{ github.event.inputs.target }}/set_matrix.sh

    - name: prinf set_matrix
      run: |
        echo '${{ steps.set_matrix.outputs.matrix }}'

  build:
    needs: set_matrix
    runs-on: ${{ github.event.inputs.os }}
    outputs:
      imageBuilder: ${{ steps.organize.outputs.imageBuilder }}
      build_target: ${{ steps.organize.outputs.build_target }}
    name: "ç¼–è¯‘ ${{matrix.repo.name}} for ${{matrix.target}} - config: ${{ github.event.inputs.config }}"
    strategy:
      fail-fast: false
      matrix:
        target: 
          - "${{ github.event.inputs.target }}"
        repo: ${{ fromJson(needs.set_matrix.outputs.build_repo) }}

    steps:
    - name: Checkout
      uses: actions/checkout@main

    # - name: install docker
    #   uses: docker-practice/actions-setup-docker@master
      
    - name: prinf machine info and matrix info
      run: |
        uname -a
        df -h
        lscpu
        free -h
        echo 'target: ${{ matrix.target }} ${{ toJSON(matrix.repo) }}'
        # ç§»åŠ¨ $target ï¼ŒåŽç»­æ­¥éª¤ä¸è®°å¾—ä¸éœ€è¦ç”¨ build/${{ github.event.inputs.target }}
        mv build/${{ github.event.inputs.target }}/* ${GITHUB_WORKSPACE}/
        \cp ${GITHUB_WORKSPACE}/build/*.buildinfo ${GITHUB_WORKSPACE}/

        if [ ${GITHUB_REF##*/} = 'test' ] && [ "$(lscpu | awk '$1=="CPU"&&$2=="MHz:"{print int($3)}')" -le 2500 ];then
          hour_num=$(TZ=Asia/Shanghai date '+%H')
          # ç™½å¤©é¢‘çŽ‡å¤ªå°ä¸æ‰§è¡Œ
          if [ "${{ github.repository_owner }}" = zhangguanzhang ] && [ $hour_num -ge 9 ];then
            echo "cpu é¢‘çŽ‡å¤ªå°ï¼Œä¸æ‰§è¡Œ"
            exit 233
          fi
        fi
    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |

        sudo mkdir -p /workdir 
        sudo chown $USER:$GROUPS /workdir
        git config --global user.email "action@github.com" && git config --global user.name "GitHub Action"

        # $target/init_runner.sh è®¾ç½® runner çš„åŸºç¡€è®¾ç½®
        if [ -f "init_runner.sh" ];then
            bash init_runner.sh
        else
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install python3-markdown $(curl -fsSL git.io/depends-ubuntu-2004) zstd upx jq pv ccache
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"

          # install github cli tool
          # gh çš„ cli ç”¨äºŽæž„å»ºç¼“å­˜å­˜å‚¨ï¼Œè¿™é‡ŒåŠ  env åˆ¤æ–­é˜²æ­¢ fork çš„äººä¸çŸ¥é“æ€Žä¹ˆè®¾ç½®è€Œæž„å»ºå¤±è´¥
          if [ -n "${{ secrets.gh_token }}" ];then
            wget -q https://github.com/cli/cli/releases/download/v2.11.3/gh_2.11.3_linux_amd64.tar.gz
            tar zxf gh_*_linux_amd64.tar.gz
            find gh_* -type f -name gh -exec mv {} /usr/local/bin/ \;
            rm -rf gh_*linux*
            sudo chmod a+x /usr/local/bin/gh
            echo ${{ secrets.gh_token }} | gh auth login --with-token
          fi
          if command -v docker &>/dev/null && [ -n "${DOCKER_PASS}" ];then
            docker login -u ${{ github.repository_owner }} -p ${DOCKER_PASS}
          fi
        fi

        git clone https://github.com/openwrt-dev/po2lmo.git
        pushd po2lmo
        make && sudo make install
        popd
        rm -rf po2lmo

        # è®¾ç½®ä¸€äº› condition ç»™åŽç»­æ­¥éª¤ä½œä¸ºåˆ¤æ–­æ¡ä»¶æˆ–è€…æ‰§è¡Œçš„å€¼
        # ä»¥åŠä¸€äº› shell
        bash env.sh
        # name-branch-target
        echo "cache_name=$( echo ${{ matrix.repo.name }}-${{ matrix.repo.branch }}-${{ matrix.target }} | awk -F/ '{print $NF}' )" >> $GITHUB_ENV

    - name: Clone source code
      working-directory: /workdir
      run: |
        set -x
        df -hT $PWD
        if [ "$UseCache" = true -a -n "${{ secrets.gh_token }}" ];then
            gh release -R ${GITHUB_REPOSITORY} list | grep -Ew cache || gh release -R ${GITHUB_REPOSITORY} create cache -t '' -n ''
            gh release -R ${GITHUB_REPOSITORY} view cache 2>/dev/null | grep -Po 'asset:\s+\K\S+' > /tmp/log || true
            if grep -E "${cache_name}.img.zst" /tmp/log;then
              echo 'start download cache:' `grep -E "${cache_name}.img.zst" /tmp/log`
              gh release -R ${GITHUB_REPOSITORY} download cache -p "${cache_name}.img.zst.*"
              cat ${cache_name}.img.zst.* | zstdmt -d -o ${GITHUB_WORKSPACE}/${cache_name}.img
              rm -f ${cache_name}.img.zst.*
            fi
        fi
        if [ ! -f "${GITHUB_WORKSPACE}/${cache_name}.img" ];then
          truncate -s 33g ${GITHUB_WORKSPACE}/${cache_name}.img && mkfs.btrfs -M ${GITHUB_WORKSPACE}/${cache_name}.img
          echo "CACHE=false" >> $GITHUB_ENV
        else
          echo "CACHE=true" >> $GITHUB_ENV
        fi
        LOOP_DEVICE=$(losetup -f) && echo "LOOP_DEVICE=$LOOP_DEVICE" >> $GITHUB_ENV
        sudo losetup -P --direct-io $LOOP_DEVICE ${GITHUB_WORKSPACE}/${cache_name}.img

        # https://forum.openwrt.org/t/using-precompiled-toolchain/87446/6
        # ç›´æŽ¥ç¼“å­˜æ‰€æœ‰ç›®å½•å¾—äº†
        #mkdir -p cache/{build_dir,staging_dir,tmp} openwrt/{build_dir,staging_dir,tmp}

        mkdir openwrt && sudo mount -o nossd,compress=zstd $LOOP_DEVICE openwrt
        # æœ‰äº›ç‰¹æ®Šè®¾å¤‡å•ç‹¬è‡ªå·±ç»´æŠ¤ç¼“å­˜å’Œæ²¡ç¼“å­˜çš„ç›®å½•å‡†å¤‡å·¥ä½œ
        if [ -f "${GITHUB_WORKSPACE}/clone.sh" ];then
            bash ${GITHUB_WORKSPACE}/clone.sh
        else
            if [ -d 'openwrt/.git' ]; then
              cd openwrt && rm -f zerospace && git config --local user.email "action@github.com" && git config --local user.name "GitHub Action"
              git fetch && git reset --hard origin/${{ matrix.repo.branch }} && git clean -df
            else
              sudo chown $USER:$(id -gn) openwrt && git clone -b ${{ matrix.repo.branch }} --single-branch ${{ matrix.repo.addr }} openwrt
            fi
            ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
            echo "BaseDir=/workdir/openwrt" >> $GITHUB_ENV
        fi

        cd ${BaseDir}
        readlink -f $GITHUB_WORKSPACE/openwrt
        ls -l . $GITHUB_WORKSPACE/ $GITHUB_WORKSPACE/openwrt/

        echo "repo_name=${{ matrix.repo.name }}" >> $GITHUB_ENV

    - name: Load custom feeds
      run: |
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
        if [ -f "$DIY_P1_SH" ];then
          chmod +x $DIY_P1_SH
          cd openwrt
          echo "Start Running: $DIY_P1_SH"
          $GITHUB_WORKSPACE/$DIY_P1_SH
        fi

    - name: Update feeds
      if: env.UdateFeeds == 'true'
      run: |
        cd openwrt
        awk '$1!~"#"{print $2}' feeds.conf.default | while read dir;do
            if [ -d feeds/${dir}/.git ];then
                pushd feeds/${dir}
                #[ -n "$(git diff --name-only)" ] && git reset --hard HEAD
                git restore .
                popd
            fi
        done
        ./scripts/feeds update -a

    - name: Install feeds
      if: env.InstallFeeds == 'true'
      run: cd openwrt && ./scripts/feeds install -a

    - name: Load custom configuration
      run: |
        
        [ -e files ] && mv files openwrt/files
        export CONFIG=${{ github.event.inputs.config }}
        echo "use the .config file:" "${CONFIG}"
        \cp config/${CONFIG} openwrt/.config

        cd openwrt
          if [ "$UdateFeeds" = true ];then
              # æ·»åŠ çš„ feeds åº”ç”¨åŒ…ä¼˜å…ˆäºŽè‡ªå¸¦çš„ feed é‡Œçš„ app
              echo "é‡å¤çš„åŒ…æ£€æµ‹ï¼šðŸ‘‡"
              ./scripts/feeds list  | awk '{if(a[$1]){print $1}else{a[$1]++}}'
              echo "é‡å¤çš„åŒ…æ£€æµ‹ï¼šðŸ‘†"
              ./scripts/feeds list  | awk '{if(a[$1]){print $1}else{a[$1]++}}' | while read pkg_name;do
                  # ç›®å½•æ˜¯ / åˆ†éš”ï¼Œfeeds/xxx/ ä¸€æ ·å°±ä¸æ‰“å°
                  find feeds/ -maxdepth 4 -type d -name $pkg_name | \
                    awk -F/ 'NR==1{a[$2]=$0};NR==2{if(!a[$2]){for(i in a){if(a[i]){printf "%s/ %s\n",$0,a[i]}}}}' | \
                    xargs -r -n2 echo  ðŸ‘‰ rsync -av --delete
                  find feeds/ -maxdepth 4 -type d -name $pkg_name | \
                    awk -F/ 'NR==1{a[$2]=$0};NR==2{if(!a[$2]){for(i in a){if(a[i]){printf "%s/ %s\n",$0,a[i]}}}}' | \
                    xargs -r -n2 rsync -av --delete
          done
        fi
        cd -

        set -x

        # feeds åŽåšäº›ä¿®æ”¹
        chmod +x $DIY_P2_SH
        pushd openwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH
        popd

        # æœ‰ç¼“å­˜å­˜åœ¨æ‰æž„å»º imageBuilderï¼Œå¦åˆ™ç¬¬ä¸€æ¬¡ç”Ÿæˆç¼“å­˜å¯èƒ½ä¼šå¾ˆä¹…ç”šè‡³å¤±è´¥ï¼Œæ­¤åˆ»æž„å»º imageBuilder æ²¡æœ‰æ„ä¹‰
        if grep -Eq '^CONFIG_IB=y'  openwrt/.config;then
            echo 'MAKE_OPTS=IGNORE_ERRORS=1' >> $GITHUB_ENV
            if [ "$CACHE" == true ];then
            # ç¼“å­˜å­˜åœ¨ä¸‹ï¼Œslim å’Œ full ç‰ˆæœ¬çš„å‡†å¤‡è¡Œä¸º
                pushd openwrt
                sed_num=$( grep -n '$(TOPDIR)/.config' target/imagebuilder/Makefile | cut -d: -f1 )
                # hack imageBuilder æž„å»ºå‡ºæ¥å¸¦ *.buildinfo å’Œ files/
                sed -ri ${sed_num}'{s#cp#& -a $(TOPDIR)/files $(TOPDIR)/*.buildinfo#;s#.config$##;}' target/imagebuilder/Makefile

                if [ "${{ matrix.repo.name }}" == lede ] || [ "${{ matrix.repo.name }}" == immortalwrt ];then
                  find package/ -type d -name luci-app-* | awk -F/ '{printf "CONFIG_PACKAGE_%s=m\n",$NF}' | sort >> .config
                  # TODO æŸ¥æ‰¾æ›´å¤šçš„ app åŒ…ï¼Œä½†æ˜¯ä¸çŸ¥é“å®¹é‡èƒ½æ’‘ä½ä¸ find  -type d -name luci-app-* | awk -F/ '!a[$NF]++{print $NF}'
                  # find -type d -name luci-app-* | awk -F/ '!a[$NF]++{printf "CONFIG_PACKAGE_%s=m\n",$NF}'| sort >> .config
                  # ä¸»é¢˜ä¸åœ¨ package é‡Œï¼Œ
                  find feeds/ -type d -name luci-theme-* | awk -F/ '!a[$NF]++{printf "CONFIG_PACKAGE_%s=m\n",$NF}' | sort >> .config
                fi

                # åŽ»é‡ï¼Œå¦‚æžœ make defconfig æ—¶å€™.config é‡Œä¸æ˜¯åŽé¢å€¼è¦†ç›–å‰é¢çš„å€¼ï¼Œé‚£å°±éœ€è¦æå‰åˆ æŽ‰ .config é‡Œçš„ luci-app* 
                find feeds -type d -name 'luci-app-*' | awk -F'/' '!a[$NF]++{print $NF}'  | \
                  sort | xargs -n1 -i echo CONFIG_PACKAGE_{}=m >> .config
                
                sed -ri 's#(^CONFIG_PACKAGE_luci-app-[^A-Z]*=)y#\1m#' .config
                # ä¸‹é¢è¿™æ ·å¤ªå¤šåŒ…å‚ä¸Žç¼–è¯‘äº†ï¼Œaction ä¼šè¶…æ—¶ï¼Œåªåƒä¸Šé¢å¼€å¯ luci-app-*
                #sed -ri '/CONFIG_PACKAGE_[0-9a-z-]+(=| )/{s@^#\s+@@;s@(=y|\s+is not set)@=m@}' .config
                popd
            else # 
                true
            fi
        else # æ²¡å¼€ imageBuilder 
            echo 'MAKE_OPTS=' >> $GITHUB_ENV
        fi

        # æ ¹ç›®å½•çš„ common docker disable
        cp *.buildinfo openwrt/
        rm -f openwrt/disable.buildinfo

        [ -f config/disable.buildinfo ] && cat config/disable.buildinfo >> disable.buildinfo

        [ "$EnableDocker" != 'true' ] && rm -f openwrt/docker.buildinfo
        cat openwrt/*.buildinfo >> openwrt/.config
        # æœ€åŽå†™å…¥ disableï¼Œç†è®ºä¸Šèƒ½è¦†ç›–æŽ‰å‰é¢çš„ä¸€äº›å¼€å¯
        cat disable.buildinfo >> openwrt/.config
        cp disable.buildinfo  openwrt/

        # ä¿ç•™ä¸€ä¸ªåŽŸæ¥å‰¯æœ¬ï¼ŒåŽç»­ full ä½¿ç”¨
        \cp config/${CONFIG} openwrt/config.buildinfo

        if grep -Eq '^CONFIG_IB=y' openwrt/.config && [ "$CACHE" == true ];then
          \cp openwrt/.config openwrt/full.buildinfo
        fi
        pushd openwrt
        sed -ri '/luci-app-.+?_dynamic=m/s#=m#=y#' .config
        make defconfig && sed -i -E 's/# (CONFIG_.*_COMPRESS_UPX) is not set/\1=y/' .config && make defconfig

    - name: cat .config
      run: |
        cd openwrt
        cat .config

    - name: SSH connection to Actions
      uses: P3TERX/ssh2actions@v1.0.0
      if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')
      env:
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

    - name: Download package
      id: package
      run: |
        cd openwrt
        if [ "$MakeDownload" == true ];then
          # é˜²æ­¢ç¼“å­˜äº†è€ç‰ˆæœ¬çš„åŒ…
          rm -rf dl/go-mod-cache
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
        fi
        ls -al ${BaseDir}

    - name: Upload buildInfo
      uses: actions/upload-artifact@main
      if: '!cancelled()'
      with:
        name: openwrt-buildInfo${{ env.DEVICE_NAME }}-${{ env.cache_name }}
        # https://github.com/actions/upload-artifact/issues/92
        path: |
          ${{ env.BaseDir }}/.config
          ${{ env.BaseDir }}/*.buildinfo

    - name: Compile the firmware
      id: compile
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        if [ -n "${{ secrets.gh_token }}" -a "${AutoBuildTimeOut}" == true ] ;then
          createdAt=$(gh -R ${GITHUB_REPOSITORY}  run list --json databaseId,createdAt --jq ".[]|select(.databaseId==${{ github.run_id }})|.createdAt")
          echo "createdAt=$createdAt" >> $GITHUB_ENV
          usedSec=$(( `date +%s` - `date -d "$createdAt" +%s`  ))
          # 6å°æ—¶è¶…æ—¶ï¼Œå‡åŽ»ä¸Šä¼  cache é¢„ç•™çš„ 15 åˆ†é’ŸåŽçš„æ—¶é—´ä½œä¸º timeout æ—¶é—´
          timeoutSec=$(( 6*60*60 - 17*60 - $usedSec  ))
          # åˆæ¬¡æ²¡ç¼“å­˜ç”¨ timeout åŽé˜²æ­¢è¶…æ—¶ action ï¼ŒåŽé¢ä¼šä¸Šä¼ ç¼“å­˜ç›®å½•
          echo timeout $timeoutSec make -j$(nproc) $MAKE_OPTS
          timeout $timeoutSec make -j$(nproc) $MAKE_OPTS |& tee -a /tmp/build.log
          # timeout è¶…æ—¶æ˜¯ 124 è¿”å›žç ï¼Œè¿™é‡Œç›´æŽ¥å…³é”®å­—åŒ¹é…åšè¯¦ç»†ä¿¡æ¯çš„ make
          if grep -qw 're-run make' /tmp/build.log;then
            echo 'failed: try to V=s'
            make -j1 || make -j1 V=s
          fi
        else
          make -j$(nproc) || make -j1 || make -j1 V=s
        fi
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
        echo "======================="
        echo "Space usage:"
        echo "======================="
        df -h
        echo "======================="
        du -h --max-depth=1 ./ --exclude=build_dir --exclude=bin
        du -h --max-depth=1 ./build_dir
        du -h --max-depth=1 ./bin

        if grep -q '^CONFIG_TARGET.*DEVICE.*=y' .config;then
          grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        else
          echo "${{ matrix.target }}" > DEVICE_NAME
        fi
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        rm -f DEVICE_NAME

    - name: retry with V=s in failed packages
      if: (!cancelled())
      run: |
        cd openwrt
        set -x
        # ç¼–è¯‘æ—¶é—´å¾ˆæ—©å®Œæˆçš„è¯ï¼Œmake -v çœ‹ä¸‹ ERROR: package/feeds/routing/cjdns failed to build. çš„ç¼–è¯‘é”™è¯¯ä¿¡æ¯
        if [ -n "${{ secrets.gh_token }}" ];then
          usedSec=$(( `date +%s` - `date -d "$createdAt" +%s`  ))
          # å°äºŽ 5 å°æ—¶æž„å»ºå®Œï¼Œæ­¤åˆ»å•ç‹¬æž„å»ºå¤±è´¥çš„
          if [ $usedSec -lt $((4*60*60)) ];then
            for pkg in `grep -Po 'ERROR:\s+\K\S+' /tmp/build.log`;do
                echo "å¼€å§‹å•ç‹¬å°è¯• make $pkg/compile V=s ç¼–è¯‘æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯"
                make $pkg/compile V=s || true
            done
          fi
        fi

    - name: Check space usage
      if: (!cancelled())
      run: |
        df -hT
        df -i
        ls -la openwrt/
        #ls -lh openwrt/bin/targets/*/* # æœ‰æ—¶å€™æ˜¯ç›®å½• openwrt/bin/targets/*
        # æ‰€ä»¥ç”¨ä¸‹é¢å®šä½ç›®å½•
        ls -lh $(dirname $(find openwrt/bin/targets/ -type d -name packages ))
        if [ -f diy-after-compile.sh ];then
          bash diy-after-compile.sh
        fi

    - name: Upload bin directory
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: openwrt/bin

    - name: Organize files
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd $(dirname $(find openwrt/bin/targets/ -type d -name packages ))
        pwd
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        # æ²¡ç¼“å­˜ï¼Œå¹¶ä¸”æœ‰å›ºä»¶ç”Ÿæˆï¼Œåˆ™ä¸Šä¼ 
        if [ `find -type f -size +5M | grep -Ev 'openwrt-imagebuilder' |wc -l` -ne 0 ] && [ "$CACHE" == false ] ;then
          echo "::set-output name=status::success"
        fi

        # ä¸‹é¢ outputs æ˜¯åŽé¢ä¸Šä¼  imageBuidler çš„åˆ¤æ–­æ¡ä»¶å’Œåå­—
        if ls *-imagebuilder-* &>/dev/null;then
          echo "::set-output name=imageBuilder::openwrt-imagebuilder-${{ env.DEVICE_NAME }}-${{ matrix.repo.name }}-${{ matrix.repo.branch }}"
        else
          echo "no_imageBuilder=true" >> $GITHUB_ENV
        fi
        echo "::set-output name=build_target::${{ matrix.target }}"

    - name: Do something after Compile
      if: steps.organize.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt
        if [ -f "$GITHUB_WORKSPACE/$DIY_AFTER" ] && [ "$no_imageBuilder" = true ] ;then
          bash $GITHUB_WORKSPACE/$DIY_AFTER
        fi

    - name: Upload firmware directory
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with: # ä¸Šä¼ å›ºä»¶
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}-${{ matrix.repo.name }}-${{ matrix.repo.branch }}
        path: |
          ${{ env.FIRMWARE }}
          !${{ env.FIRMWARE }}/openwrt-imagebuilder*

    - name: Upload imagebuilder tar.xz
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.imageBuilder && !cancelled()
      with: # ä¸Šä¼  imageBuilder
        name: openwrt-imagebuilder-${{ env.DEVICE_NAME }}-${{ matrix.repo.name }}-${{ matrix.repo.branch }}
        path: ${{ env.FIRMWARE }}/*-imagebuilder*

    - name: Upload firmware to cowtransfer
      id: cowtransfer
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_COWTRANSFER == 'true' && !cancelled()
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer cow --block 2621440 -s -p 64 --no-progress ${FIRMWARE} 2>&1 | tee cowtransfer.log
        echo "::warning file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
        echo "::set-output name=url::$(cat cowtransfer.log | grep https | cut -f3 -d" ")"

    - name: Upload firmware to WeTransfer
      id: wetransfer
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_WETRANSFER == 'true' && !cancelled()
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer wet -s -p 16 --no-progress ${FIRMWARE} 2>&1 | tee wetransfer.log
        echo "::warning file=wetransfer.com::$(cat wetransfer.log | grep https)"
        echo "::set-output name=url::$(cat wetransfer.log | grep https | cut -f3 -d" ")"

    - name: Generate release tag
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        echo "::set-output name=release_tag::$(date +"%Y.%m.%d-%H%M")"
        touch release.txt
        [ $UPLOAD_COWTRANSFER = true ] && echo "ðŸ”— [Cowtransfer](${{ steps.cowtransfer.outputs.url }})" >> release.txt
        [ $UPLOAD_WETRANSFER = true ] && echo "ðŸ”— [WeTransfer](${{ steps.wetransfer.outputs.url }})" >> release.txt
        echo "::set-output name=status::success"

    - name: Upload firmware to release
      uses: softprops/action-gh-release@v1
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: Clean space for upload cache
      id: up_cache_before
      if: "!cancelled() && env.ClearPkg == 'true'"
      continue-on-error: true
      run: |
        sync
        sha256_path=$(find openwrt/bin/targets/ -type f -name sha256sums )
        if [ -n "$sha256_path" ];then
          pushd $(dirname $sha256_path)
          if ls *-imagebuilder-* &>/dev/null;then
            # æœ‰ imagebuilderä¸‹ï¼Œæ¸…ç†ä¸‹ï¼Œé˜²æ­¢æ­¤æ­¥ä¸Šä¼ è¶…æ—¶
            rm -rf openwrt-*
          fi
          popd
        fi

        nohup sh -c '
        echo "Listing 100 largest packages"
        dpkg-query -Wf '${Installed-Size}\t${Package}\n' | sort -n | tail -n 100
        df -h
        echo "Removing large packages"
        sudo apt-get remove -y '^ghc-8.*' || true
        sudo apt-get remove -y '^dotnet-.*' || true
        sudo apt-get remove -y '^llvm-.*' || true
        sudo apt-get remove -y 'php.*' || true
        sudo apt-get remove -y azure-cli google-cloud-sdk hhvm google-chrome-stable firefox powershell mono-devel || true
        sudo apt-get autoremove -y || true
        sudo apt-get clean || true
        df -h
        df -i
        ' &
    - name: Upload cache to release
      id: up_cache
      if: '!cancelled()'
      continue-on-error: true
      run: |

        if [ "${UseCache}" == true -a -n "${{ secrets.gh_token }}" ];then
          set -x
          # TODO
          # å¯ä»¥åœ¨ç›®å½•é‡Œåœ¨æ–‡ä»¶ env é‡Œå†™å…¥æ—¶é—´ï¼Œç„¶åŽåœ¨ compile ä¹‹å‰ï¼Œå¦‚æžœæ–‡ä»¶æ—¶é—´æ¯”å½“å‰æ—¶é—´å·®è·å¤§äºŽ2å¤©ï¼Œåˆ™åˆ é™¤ dl/go-mod-cache
          rm -rf openwrt/{bin,tmp,files}
          #sudo umount openwrt/{build_dir,staging_dir,tmp} cache
          # https://unix.stackexchange.com/questions/18048/list-only-bind-mounts
          # for path in `sudo findmnt --kernel -n --list | grep '\[' | awk -vWorkDir="$GITHUB_WORKSPACE"  '($2 ~ WorkDir"/cache/" && $1 ~ WorkDir"/openwrt/"){print $1}'`;do
          #   sudo umount $path
          # done
          # sudo umount cache
          sleep 1
          sudo mount -o remount,compress=no,nodatacow,nodatasum openwrt
          # https://github.com/klever1988/nanopi-openwrt/issues/1158
          pv /dev/zero > openwrt/zerospace || true
          sync
          rm -f openwrt/zerospace || true
          sleep 5
          sudo umount -f openwrt
          sleep 2
          # sudo losetup -l -O NAME -n | awk '$0~"/'${cache_name}'.img"{print $1}' | xargs -r sudo losetup -d
          sudo losetup -d $LOOP_DEVICE
          sync
          zstdmt -c --long ${cache_name}.img | split --numeric=1 -b 2000m - ${cache_name}.img.zst.
          ls -l
          rm -f ${cache_name}.img # å‡å°‘å®¹é‡
          # å¯èƒ½å­˜åœ¨å½“å‰ä¸Šä¼ çš„åˆ‡å‰²æ–‡ä»¶æ•°é‡å°‘äºŽ cache release ä¸Šçš„ï¼Œéœ€è¦æå‰åˆ é™¤
          gh release -R ${GITHUB_REPOSITORY} view cache  2>/dev/null | grep -Po "asset:\s+\K${cache_name}.img.zst.\d+" | \
              xargs -r -n1 gh release -R ${GITHUB_REPOSITORY} delete-asset cache  -y
          gh release -R ${GITHUB_REPOSITORY} upload cache ${cache_name}.img.zst.* --clobber
        fi

    - name: Delete workflow runs
      uses: GitRML/delete-workflow-runs@main
      with:
        retain_days: 1
        keep_minimum_runs: 3

    - name: Remove old Releases
      uses: dev-drprasad/delete-older-releases@v0.1.0
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build_slim:
    needs: [set_matrix, build]
    if: needs.build.outputs.imageBuilder
    runs-on: ${{ github.event.inputs.os }}
    name: "ç¼–è¯‘ ${{matrix.repo.name}}-${{matrix.repo.branch}}: ${{matrix.target}}"
    strategy:
      fail-fast: false
      matrix:
        target: 
          - "slim"
          - "full"
        repo: ${{ fromJson(needs.set_matrix.outputs.build_repo) }}
    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: install docker
      uses: docker-practice/actions-setup-docker@master
      
    - name: prinf info
      run: |
        df -h
        lscpu
        free -h
        #                   slim/full
        echo 'target: ${{matrix.target}}' 'repo: ${{ toJSON(matrix.repo) }}'

    - name: Initialization environment
      id: init
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install python3-markdown $(curl -fsSL git.io/depends-ubuntu-2004) jq rename
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
        i=0
        while [ "$i" -le 100 ];do
          if command -v docker &>/dev/null && [ -n "${DOCKER_PASS}" ];then
            docker info | grep -wq '${{ github.repository_owner }}'  || docker login -u ${{ github.repository_owner }} -p ${DOCKER_PASS}
            docker login -u ${{ github.repository_owner }}@qq.com -p ${DOCKER_PASS} registry.aliyuncs.com
            [ "$?" -eq 0 ] && break || lei i++
          fi
        done
        docker info

        # install github cli tool
        # ä¸Šä¼ åˆ°lateståˆ†æ”¯
        if [ -n "${{ secrets.gh_token }}" ];then
          wget -q https://github.com/cli/cli/releases/download/v2.11.3/gh_2.11.3_linux_amd64.tar.gz
          tar zxf gh_*_linux_amd64.tar.gz
          find gh_* -type f -name gh -exec mv {} /usr/local/bin/ \;
          rm -rf gh_*linux*
          sudo chmod a+x /usr/local/bin/gh
          echo ${{ secrets.gh_token }} | gh auth login --with-token
          echo "::set-output name=gh::success"
        fi

    - name: Download imagebuilder (Artifact)
      uses: actions/download-artifact@v2
      with:
        name: ${{ needs.build.outputs.imageBuilder }}
        path: .

    - name: Compile the firmware
      id: compile
      run: |
        ls -l
        \cp -a ${GITHUB_WORKSPACE}/build/${{ needs.build.outputs.build_target }}/* ${GITHUB_WORKSPACE}/build/common.buildinfo ${GITHUB_WORKSPACE}/
        tar xf openwrt-imagebuilder-*.tar.xz
        rm -f openwrt-imagebuilder-*.tar.xz
        ln -sf openwrt-imagebuilder-* openwrt
        cd openwrt-imagebuilder-*
        ls -l

        echo -e "$(nproc) thread compile"
        ls -1 packages/*.ipk | wc -l
        ls packages/

        > /tmp/log
        if [ "${{matrix.target}}" == 'slim' ];then
          mkdir -p files/local_feed && sudo mount --bind packages files/local_feed
          echo "suffix=-slim" >> $GITHUB_ENV
        else
          echo "suffix=-full" >> $GITHUB_ENV
        fi

        sed -i 's/luci-app-[^ ]*//g' include/target.mk $(find target/ -name Makefile)
        ls packages/*.ipk | xargs -n1 basename > package.list
        #PACKAGES=$(grep -v CONFIG_PACKAGE_luci-app common.buildinfo | grep -Po '^CONFIG_PACKAGE_\K[^A-Z=]+(?==y)' | xargs -n1 -i grep -o {} package.list | sort -u | xargs echo )
        #extra_pkgs="luci-i18n-base-zh-cn luci-i18n-firewall-zh-cn luci-app-ttyd bash default-settings luci-app-docker -luci-app-ssr-plus -luci-app-samba"

        extra_pkgs=" -luci-app-ssr-plus -luci-app-samba"
        if [ "${{matrix.target}}" == 'slim' ];then
          extra_pkgs+=' -luci-app-docker'
          PACKAGES=$( grep -Po '^CONFIG_PACKAGE_\K[^A-Z=]+' common.buildinfo | tr '\n' ' ' )
        else
          PACKAGES=$( grep -Po '^CONFIG_PACKAGE_\K[^A-Z=]+(?==y)' full.buildinfo | xargs -n1 -i grep -o {} package.list | awk '!a[$0]++' | xargs echo )
          # å­˜åœ¨ docker.buildinfo å°±å®‰è£…docker
          [ -f docker.buildinfo ] && extra_pkgs+=' luci-app-dockerman'
        fi
        make image PACKAGES="$PACKAGES ${extra_pkgs} " FILES="files" |& tee -a /tmp/log
        REMOVE_PKGS=$( grep -Po 'Cannot install package \K[^.]+' /tmp/log | awk '{printf "-%s ",$0}' )
        if [ -n "$REMOVE_PKGS" ];then
          echo "æ‰“åŒ…æŠ¥é”™ï¼Œä»¥ä¸‹åŒ…å­˜åœ¨ä¾èµ–é—®é¢˜: ${REMOVE_PKGS}"
          echo "å°è¯•ç§»é™¤ä¸Šé¢çš„åŒ…æ‰“åŒ…"
          # ä¸åˆ é™¤åˆ™ä¼šæ–‡ä»¶å·²å­˜åœ¨è€Œä¸æ›´æ–°ç­¾åï¼Œè²Œä¼¼è¿™æ ·ä¹Ÿè§£å†³ä¸äº†ã€‚ã€‚,åŽé¢æ”¹ sed -ri '/check_signature/s@^[^#]@#&@' /etc/opkg.conf æš‚æ—¶å±è”½å‰é¢é”™è¯¯
          rm -f files/local_feed/Packages*
          make image PACKAGES="$PACKAGES ${extra_pkgs} ${REMOVE_PKGS}" FILES="files"
        fi

        #make image -j$(nproc) PACKAGES='-luci-app-ipsec-vpnd' || make image -j1 V=s PACKAGES='-luci-app-ipsec-vpnd' 

        echo "::set-output name=status::success"
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=$(cat DEVICE_NAME)" >> $GITHUB_ENV
        echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: Organize files
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd openwrt-imagebuilder-*/bin/targets/*/*
        pwd
        ls -lh
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "::set-output name=status::success"

    - name: Do something after Compile
      if: steps.organize.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt-imagebuilder-*/
        if [ -f "$GITHUB_WORKSPACE/$DIY_AFTER" ];then
          export device_name=${{ needs.build.outputs.build_target }}
          bash $GITHUB_WORKSPACE/$DIY_AFTER ${{ matrix.repo.name }}-${{ matrix.repo.branch }} ${{ env.suffix }} 
        fi

    - name: Upload firmware directory
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware-${{ env.DEVICE_NAME }}_${{ env.FILE_DATE }}${{ env.suffix }}-${{ matrix.repo.name }}-${{ matrix.repo.branch }}
        path: |
          ${{ env.FIRMWARE }}

    - name: Upload firmware to release
      if: steps.init.outputs.gh == 'success' && !cancelled()
      run: |
        set -x
        cd openwrt-imagebuilder-*/bin/targets/*/*
        name_str_target=${{ needs.build.outputs.build_target }}
        [ "$name_str_target" = 'x86_64' ] && name_str_target=x86-64

        prename -v "s#^.+${name_str_target}#${{ matrix.repo.name }}-${{ matrix.repo.branch }}-${{ needs.build.outputs.build_target }}${suffix}#" *${name_str_target}*
        mv sha256sums ${{ matrix.repo.name }}-${{ matrix.repo.branch }}-${{ needs.build.outputs.build_target }}${suffix}-sha256sums
        ls -l
        [ ${GITHUB_REF##*/} = 'main' ] && tag=latest || tag=test
        gh release -R ${GITHUB_REPOSITORY} list | grep -Ew ${tag} || gh release -R ${GITHUB_REPOSITORY} create ${tag} -t '' -n ''
        gh release -R ${GITHUB_REPOSITORY} upload ${tag} * --clobber
